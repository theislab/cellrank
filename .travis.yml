language: python

python:
  - "3.6"
  - "3.7"
  - "3.8"

os: linux

cache: pip

env:
  - USE_SLEPC=true CACHE_NAME=default
  - USE_SLEPC=false CACHE_NAME=default

jobs:
  include:
    - name: "Python 3.6.5 on macOS"
      language: bash
      os: osx
      osx_image: xcode9.4
      env:
        - PYTHON_VERSION=3.6.5 USE_SLEPC=false

    - name: "Python 3.7.3 on macOS"
      language: bash
      os: osx
      osx_image: xcode10.2
      env:
        - PYTHON_VERSION=3.7.3 USE_SLEPC=false

    - name: "Python 3.8 deployment"
      python: 3.8
      env:
        - USE_SLEPC=false CACHE_NAME=default
        - secure: "vtnfOfC1nWYTIdYou8+btuSL4rXlLQlLjLDSa4vcL3vuDyLxFXrrMxVCajkod4hlbrS6otHZiSOlq3DCZ3ToyVMT+Q5flrAUxWkMElK+NyRe8/XDWftPy6/Rwp/VaFBv0yzPRRA39u9z6FPcSF/etH+8SAHSfIjU7HKhou+KSgcp89YzZECTJiXmZKml0X16Kwy9zThm+0broVpRi2hHC+UcvMiAB18AKT7deLefRQR71mCkDX9o685zVNBChsGM3tYwTVm+EnhGqfYzBP4cSRrjZbsNHP9pILxHq8u7PlvAQuSkjlv0CBDHFbMd76vYK2NKbA0ZQr8ZGBBFcHzyVv8xlC9yStfrJ0orapw2jXiNgAKHf8agW10CG50UIxq8kGIdAIhS1oDg3t49DmGoyA4qnnsYBLz/t2JA82MfkkGEUDq7NxnyvdbACRsiRFF6YnOYCsO4ZWLqzcNaYHe6LCBJG3RKAcaw6GJ7hfSQy8W164hkxQGiT/nPsiqW8ndJ2ef43ntpFPfYQmc5/U+zwmqKDZGEbHopvvCLGl1FhGCzzNh+YKaGOXgRuokh5GOmxKYRUKNm+9AgHrNokkdZBdlcoDzrjxqMstRv1HsycFRNdpQ+ThLjbKVaZRhO62XH5g2kjv5A3b7OvIpU2cH1RdTPkmaIVQC1byyRC3RkPqM="

    - name: "Python 3.6 on Linux PETSc/SLEPc using extra_requires"
      python: 3.6
      env:
        - USE_SLEPC=true CACHE_NAME=krylov

before_cache:
  # don't use cache in this case, because we're testing whether pip install cellrank[krylov] works
  - if [[ "$CACHE_NAME" == "krylov" ]]; then sudo rm -rf "$HOME/.cache/pip"; fi

before_install:
  - ./.scripts/ci/before_install.sh || travis_terminate 1

install:
  - ./.scripts/ci/install.sh || travis_terminate 1

script:
  - travis_wait 15 ./.scripts/ci/test.sh

after_success:
  - ./.scripts/ci/upload_coverage.sh

deploy:
  - provider: pypi
    username: "__token__"
    password:
      secure: "wTD+QMCulMrDEVJ77W03lD+qQFVTFHn00qp99Vb+nA5FMggDC0kTMjPdqsaBAihqygFb/gJwEdbUJzGERcBq4EFwjvc6l1pK7O5G1EfB29BpLIwFTTeZpkizev3RUV6c9KWEBMi9BneqXaECHO7XtTfR+RzbVYD1/cjBoyAGkhl354UVksX+KcRQGECvfLcyPWGt6J/2eb8GAGkTI3gq3DNDh7ehDiFLQVMZoL7Cev/S9UjzU2yDWIvnaNvm0ubZBb/1hY8xqKH/QjaLv7HYYzWnHwy7IWFJrqKGHN8zDDGrda35iOh/1d7tQBOjFaQZwaUiO2Lem2zPaQ0vXsK7TpIxEsa+K+Fqd3S83B+BsQZsg4Sny9cu4lNUHuuHD0a2XOz+aTvDIJ2A0Pd7C6XdYoVky042cRyLEiZ0efIOJowbSyKxIi4b85nEG2yIo2Aq5qHcKuSWDiNTUmwXK+Xfs84LUNig9xQJDv721XBACfeBEZs5Czv0pG8qphmGFrREOaRZ7zsrlQ+ODJvyGDXvj1jUiqFzL9/xvqmr59lhARD50WEbT1QI7KvcLZ6pCUU1zmjViaC1KAGi1f4RHP43Bwu9Zq1l0oMwyq/KdYhWQCHPnfed8vb0v8Y6emA9oenugqbmX+HpBXsh4cD3CoAxG2ULhvcbiVP7bYUEBi9B2gQ="
    distributions: "sdist bdist_wheel"
    skip_existing: true
    on:
      tags: true
      condition: ! -z ${BIOCONDA_RECIPES+x}

  - provider: script
    script: ./.scripts/ci/upload_bioconda.sh
    on:
      tags: true
      condition: ! -z ${BIOCONDA_RECIPES+x}
